<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PatchFrame Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: #f7fafc;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #718096;
        }

        .critical { color: #e53e3e; }
        .high { color: #dd6b20; }
        .medium { color: #d69e2e; }
        .low { color: #38a169; }

        .vulnerability-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .vulnerability-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid;
            background: #f7fafc;
            transition: background-color 0.2s ease;
        }

        .vulnerability-item:hover {
            background: #edf2f7;
        }

        .vulnerability-item.critical { border-left-color: #e53e3e; }
        .vulnerability-item.high { border-left-color: #dd6b20; }
        .vulnerability-item.medium { border-left-color: #d69e2e; }
        .vulnerability-item.low { border-left-color: #38a169; }

        .vuln-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .vuln-name {
            font-weight: bold;
            color: #2d3748;
        }

        .vuln-severity {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .vuln-severity.critical { background: #fed7d7; color: #c53030; }
        .vuln-severity.high { background: #feebc8; color: #c05621; }
        .vuln-severity.medium { background: #fef5e7; color: #b7791f; }
        .vuln-severity.low { background: #c6f6d5; color: #2f855a; }

        .vuln-description {
            color: #4a5568;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .vuln-meta {
            margin-top: 8px;
            font-size: 0.8rem;
            color: #718096;
        }

        .chart-container {
            height: 300px;
            margin-top: 20px;
        }

        .dependency-graph {
            height: 400px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f7fafc;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            stroke: #2d3748;
            stroke-width: 2px;
        }

        .link {
            stroke: #cbd5e0;
            stroke-opacity: 0.6;
            stroke-width: 1px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
        }

        .btn-primary:hover {
            background: #3182ce;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß© PatchFrame Dashboard</h1>
            <p>Real-Time Patch-Level Vulnerability Scanner</p>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="loadLatestScan()">Refresh Data</button>
            <button class="btn btn-secondary" onclick="exportData()">Export Results</button>
            <button class="btn btn-secondary" onclick="showSettings()">Settings</button>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading scan data...</p>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="dashboard-grid">
                <!-- Summary Stats -->
                <div class="card">
                    <h3>üìä Scan Summary</h3>
                    <div class="stats-grid" id="summary-stats">
                        <!-- Stats will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Vulnerability Distribution -->
                <div class="card">
                    <h3>üéØ Vulnerability Distribution</h3>
                    <div class="chart-container" id="vuln-chart"></div>
                </div>

                <!-- Trust Scores -->
                <div class="card">
                    <h3>üîí Trust Analysis</h3>
                    <div class="chart-container" id="trust-chart"></div>
                </div>

                <!-- Anomaly Detection -->
                <div class="card">
                    <h3>üö® Anomaly Detection</h3>
                    <div class="chart-container" id="anomaly-chart"></div>
                </div>
            </div>

            <!-- Vulnerabilities List -->
            <div class="card">
                <h3>üîç Detected Vulnerabilities</h3>
                <div class="vulnerability-list" id="vulnerabilities-list">
                    <!-- Vulnerabilities will be populated by JavaScript -->
                </div>
            </div>

            <!-- Dependency Graph -->
            <div class="card">
                <h3>üåê Dependency Graph</h3>
                <div class="dependency-graph" id="dependency-graph"></div>
            </div>
        </div>
    </div>

    <script>
        let scanData = null;

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadLatestScan();
        });

        async function loadLatestScan() {
            try {
                showLoading(true);
                
                // Try to load from API first
                const response = await fetch('/api/v1/scans?limit=1');
                if (response.ok) {
                    const scans = await response.json();
                    if (scans.length > 0) {
                        await loadScanData(scans[0].scan_id);
                        return;
                    }
                }
                
                // No scan data available
                throw new Error('No scan data available. Please run a scan first.');
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load scan data. Please run a scan first.');
            } finally {
                showLoading(false);
            }
        }

        async function loadScanData(scanId) {
            const response = await fetch(`/api/v1/scan/${scanId}`);
            if (response.ok) {
                const scanResult = await response.json();
                if (scanResult.result) {
                    scanData = scanResult.result;
                    renderDashboard();
                } else {
                    throw new Error('Scan not completed yet');
                }
            } else {
                throw new Error('Failed to load scan data');
            }
        }

        function renderDashboard() {
            if (!scanData) return;

            renderSummaryStats();
            renderVulnerabilityChart();
            renderTrustChart();
            renderAnomalyChart();
            renderVulnerabilitiesList();
            renderDependencyGraph();

            document.getElementById('dashboard').style.display = 'block';
        }

        function renderSummaryStats() {
            const summary = scanData.summary || {};
            const statsContainer = document.getElementById('summary-stats');
            
            statsContainer.innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${summary.total_dependencies || 0}</div>
                    <div class="stat-label">Dependencies</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number critical">${summary.critical_vulns || 0}</div>
                    <div class="stat-label">Critical</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number high">${summary.high_vulns || 0}</div>
                    <div class="stat-label">High</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number medium">${summary.medium_vulns || 0}</div>
                    <div class="stat-label">Medium</div>
                </div>
            `;
        }

        function renderVulnerabilityChart() {
            const summary = scanData.summary || {};
            const data = [
                { label: 'Critical', value: summary.critical_vulns || 0, color: '#e53e3e' },
                { label: 'High', value: summary.high_vulns || 0, color: '#dd6b20' },
                { label: 'Medium', value: summary.medium_vulns || 0, color: '#d69e2e' },
                { label: 'Low', value: summary.low_vulns || 0, color: '#38a169' }
            ].filter(d => d.value > 0);

            if (data.length === 0) {
                document.getElementById('vuln-chart').innerHTML = '<p style="text-align: center; color: #718096;">No vulnerabilities detected</p>';
                return;
            }

            const width = document.getElementById('vuln-chart').clientWidth;
            const height = 300;
            const radius = Math.min(width, height) / 2 - 40;

            // Clear previous chart
            d3.select('#vuln-chart').selectAll('*').remove();

            const svg = d3.select('#vuln-chart')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width/2},${height/2})`);

            const pie = d3.pie().value(d => d.value);
            const arc = d3.arc().innerRadius(0).outerRadius(radius);

            const arcs = svg.selectAll('arc')
                .data(pie(data))
                .enter()
                .append('g');

            arcs.append('path')
                .attr('d', arc)
                .attr('fill', d => d.data.color)
                .attr('stroke', 'white')
                .style('stroke-width', '2px');

            // Add labels
            arcs.append('text')
                .attr('transform', d => `translate(${arc.centroid(d)})`)
                .attr('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('font-weight', 'bold')
                .style('fill', 'white')
                .text(d => d.data.label);

            // Add values
            arcs.append('text')
                .attr('transform', d => `translate(${arc.centroid(d)})`)
                .attr('text-anchor', 'middle')
                .attr('dy', '1.2em')
                .style('font-size', '14px')
                .style('font-weight', 'bold')
                .style('fill', 'white')
                .text(d => d.data.value);
        }

        function renderTrustChart() {
            const vulnerabilities = scanData.vulnerabilities || [];
            const trustScores = vulnerabilities
                .filter(v => v.trust_score !== undefined)
                .map(v => v.trust_score);

            if (trustScores.length === 0) {
                document.getElementById('trust-chart').innerHTML = '<p style="text-align: center; color: #718096;">No trust score data available</p>';
                return;
            }

            const width = document.getElementById('trust-chart').clientWidth;
            const height = 300;
            const margin = { top: 20, right: 20, bottom: 40, left: 40 };

            // Clear previous chart
            d3.select('#trust-chart').selectAll('*').remove();

            const svg = d3.select('#trust-chart')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const x = d3.scaleLinear()
                .domain([0, 1])
                .range([margin.left, width - margin.right]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(trustScores) || 1])
                .range([height - margin.bottom, margin.top]);

            // Add histogram
            const histogram = d3.histogram()
                .domain(x.domain())
                .thresholds(x.ticks(20));

            const bins = histogram(trustScores);

            const yHist = d3.scaleLinear()
                .domain([0, d3.max(bins, d => d.length)])
                .range([height - margin.bottom, margin.top]);

            svg.selectAll('rect')
                .data(bins)
                .enter()
                .append('rect')
                .attr('x', d => x(d.x0))
                .attr('y', d => yHist(d.length))
                .attr('width', d => Math.max(0, x(d.x1) - x(d.x0) - 1))
                .attr('height', d => height - margin.bottom - yHist(d.length))
                .attr('fill', '#4299e1')
                .attr('opacity', 0.7);

            // Add axes
            svg.append('g')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x))
                .append('text')
                .attr('x', width / 2)
                .attr('y', 35)
                .attr('text-anchor', 'middle')
                .text('Trust Score');

            svg.append('g')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(yHist))
                .append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', -30)
                .attr('x', -(height / 2))
                .attr('text-anchor', 'middle')
                .text('Frequency');
        }

        function renderAnomalyChart() {
            const vulnerabilities = scanData.vulnerabilities || [];
            const anomalyScores = vulnerabilities
                .filter(v => v.anomaly_score !== undefined)
                .map(v => v.anomaly_score);

            if (anomalyScores.length === 0) {
                document.getElementById('anomaly-chart').innerHTML = '<p style="text-align: center; color: #718096;">No anomaly data available</p>';
                return;
            }

            const width = document.getElementById('anomaly-chart').clientWidth;
            const height = 300;
            const margin = { top: 20, right: 20, bottom: 40, left: 40 };

            // Clear previous chart
            d3.select('#anomaly-chart').selectAll('*').remove();

            const svg = d3.select('#anomaly-chart')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const x = d3.scaleLinear()
                .domain([0, 1])
                .range([margin.left, width - margin.right]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(anomalyScores) || 1])
                .range([height - margin.bottom, margin.top]);

            // Add scatter plot
            svg.selectAll('circle')
                .data(anomalyScores)
                .enter()
                .append('circle')
                .attr('cx', d => x(d))
                .attr('cy', d => y(d))
                .attr('r', 4)
                .attr('fill', d => d > 0.7 ? '#e53e3e' : d > 0.5 ? '#dd6b20' : '#4299e1')
                .attr('opacity', 0.7);

            // Add axes
            svg.append('g')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x))
                .append('text')
                .attr('x', width / 2)
                .attr('y', 35)
                .attr('text-anchor', 'middle')
                .text('Anomaly Score');

            svg.append('g')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(y))
                .append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', -30)
                .attr('x', -(height / 2))
                .attr('text-anchor', 'middle')
                .text('Anomaly Score');
        }

        function renderVulnerabilitiesList() {
            const vulnerabilities = scanData.vulnerabilities || [];
            const container = document.getElementById('vulnerabilities-list');
            
            if (vulnerabilities.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096;">No vulnerabilities detected</p>';
                return;
            }

            container.innerHTML = vulnerabilities.map(vuln => `
                <div class="vulnerability-item ${vuln.severity}">
                    <div class="vuln-header">
                        <div class="vuln-name">${vuln.dependency_name}@${vuln.dependency_version}</div>
                        <div class="vuln-severity ${vuln.severity}">${vuln.severity}</div>
                    </div>
                    <div class="vuln-description">${vuln.description}</div>
                    <div class="vuln-meta">
                        Patch: ${vuln.patch_sha} | Author: ${vuln.patch_author} | Confidence: ${(vuln.confidence * 100).toFixed(1)}%
                        ${vuln.trust_score ? `| Trust: ${(vuln.trust_score * 100).toFixed(1)}%` : ''}
                        ${vuln.anomaly_score ? `| Anomaly: ${(vuln.anomaly_score * 100).toFixed(1)}%` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderDependencyGraph() {
            const dependencies = scanData.dependencies || [];
            
            if (dependencies.length === 0) {
                document.getElementById('dependency-graph').innerHTML = '<p style="text-align: center; color: #718096;">No dependencies found</p>';
                return;
            }

            const width = document.getElementById('dependency-graph').clientWidth;
            const height = 400;

            // Clear previous graph
            d3.select('#dependency-graph').selectAll('*').remove();

            const svg = d3.select('#dependency-graph')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Create force simulation
            const simulation = d3.forceSimulation(dependencies)
                .force('link', d3.forceLink().id(d => d.name).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2));

            // Add nodes
            const nodes = svg.selectAll('.node')
                .data(dependencies)
                .enter()
                .append('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            nodes.append('circle')
                .attr('r', 8)
                .attr('fill', '#4299e1')
                .attr('stroke', '#2d3748')
                .attr('stroke-width', 2);

            nodes.append('text')
                .attr('dx', 12)
                .attr('dy', '.35em')
                .text(d => d.name)
                .style('font-size', '12px')
                .style('font-weight', 'bold');

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            simulation.on('tick', () => {
                nodes.attr('transform', d => `translate(${d.x},${d.y})`);
            });
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('dashboard').style.display = show ? 'none' : 'block';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.controls'));
        }

        function exportData() {
            if (!scanData) {
                alert('No data to export');
                return;
            }

            const dataStr = JSON.stringify(scanData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `patchframe-scan-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function showSettings() {
            alert('Settings functionality coming soon!');
        }

        // Auto-refresh every 30 seconds
        setInterval(loadLatestScan, 30000);
    </script>
</body>
</html> 